#!/bin/bash
set -e

# Colors for output
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
RED='\033[0;31m'
NC='\033[0m' # No Color

# Cleanup function for graceful shutdown
cleanup() {
    echo ""
    echo -e "${YELLOW}ğŸ›‘ Shutting down...${NC}"

    # Check if Supabase is running
    if supabase status &> /dev/null; then
        echo -e "${BLUE}Supabase is still running in the background.${NC}"
        read -p "$(echo -e ${YELLOW}Do you want to stop Supabase? [y/N]: ${NC})" -n 1 -r
        echo ""
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            echo -e "${YELLOW}Stopping Supabase...${NC}"
            supabase stop
            echo -e "${GREEN}âœ“ Supabase stopped${NC}"
        else
            echo -e "${BLUE}Supabase containers are still running.${NC}"
            echo -e "${BLUE}To stop them later, run: ${YELLOW}./scripts/stop${NC} or ${YELLOW}supabase stop${NC}"
        fi
    fi

    exit 0
}

# Set up trap to catch Ctrl+C and other termination signals
trap cleanup SIGINT SIGTERM

echo -e "${GREEN}ğŸš€ Starting ISE Alumni Portal (Local Development)${NC}\n"

# Check if .env.local exists
if [ ! -f ".env.local" ]; then
    echo -e "${RED}âŒ .env.local not found. Run ./scripts/setup first!${NC}"
    exit 1
fi

# Validate required environment variables
echo "Validating environment variables..."
MISSING_REQUIRED=()

# Source the .env.local file to check variables
set -a
source .env.local
set +a

# Check for truly required variables (Supabase config)
if [ -z "$VITE_SUPABASE_URL" ]; then
    MISSING_REQUIRED+=("VITE_SUPABASE_URL")
fi

if [ -z "$VITE_SUPABASE_ANON_KEY" ]; then
    MISSING_REQUIRED+=("VITE_SUPABASE_ANON_KEY")
fi

# Report missing required variables and exit
if [ ${#MISSING_REQUIRED[@]} -gt 0 ]; then
    echo -e "${RED}âŒ Missing required environment variables in .env.local:${NC}"
    for var in "${MISSING_REQUIRED[@]}"; do
        echo -e "   ${YELLOW}â€¢ $var${NC}"
    done
    echo ""
    echo -e "${YELLOW}Re-run ./scripts/setup to regenerate Supabase configuration.${NC}"
    exit 1
fi

echo -e "${GREEN}âœ“ Required environment variables are set${NC}"

# Warn about optional but useful variables
if [ -z "$VITE_MAPBOX_TOKEN" ]; then
    echo -e "${YELLOW}âš ï¸  VITE_MAPBOX_TOKEN is not set${NC}"
    echo -e "${YELLOW}   Map features will not work. Get a token at: https://account.mapbox.com/access-tokens/${NC}"
fi

echo ""

# Check if Docker is running
if ! docker info &> /dev/null; then
    echo -e "${YELLOW}âŒ Docker is not running. Please start Docker Desktop.${NC}"
    exit 1
fi

# Start Supabase if not already running
echo "Starting local Supabase..."
if supabase status &> /dev/null; then
    echo -e "${GREEN}âœ“ Supabase already running${NC}"
else
    supabase start
    echo -e "${GREEN}âœ“ Supabase started${NC}"
fi
echo ""

# Display connection info
echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo -e "${GREEN}ğŸ”§ Local Development Environment${NC}"
echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo -e "Supabase Studio: ${YELLOW}http://127.0.0.1:54323${NC}"
echo -e "Database URL:     ${YELLOW}postgresql://postgres:postgres@127.0.0.1:54322/postgres${NC}"
echo -e "Frontend:         ${YELLOW}http://localhost:5173${NC}"
echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo -e "${GREEN}ğŸ”‘ Test Users (All passwords: password123)${NC}"
echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"

# Fetch one user of each type from the database
ADMIN_EMAIL=$(docker exec supabase_db_ise-alumni psql -U postgres -t -c "SELECT u.email FROM auth.users u JOIN public.profiles p ON u.id = p.user_id WHERE p.user_type = 'Admin' LIMIT 1;" 2>/dev/null | tr -d ' ')
STAFF_EMAIL=$(docker exec supabase_db_ise-alumni psql -U postgres -t -c "SELECT u.email FROM auth.users u JOIN public.profiles p ON u.id = p.user_id WHERE p.user_type = 'Staff' LIMIT 1;" 2>/dev/null | tr -d ' ')
ALUM_EMAIL=$(docker exec supabase_db_ise-alumni psql -U postgres -t -c "SELECT u.email FROM auth.users u JOIN public.profiles p ON u.id = p.user_id WHERE p.user_type = 'Alum' LIMIT 1;" 2>/dev/null | tr -d ' ')

# Display users if they exist
if [ -n "$ADMIN_EMAIL" ]; then
  echo -e "Admin: ${YELLOW}$ADMIN_EMAIL${NC}"
fi
if [ -n "$STAFF_EMAIL" ]; then
  echo -e "Staff: ${YELLOW}$STAFF_EMAIL${NC}"
fi
if [ -n "$ALUM_EMAIL" ]; then
  echo -e "Alum:  ${YELLOW}$ALUM_EMAIL${NC}"
fi

# Fallback to basic seed user if no users found
if [ -z "$ADMIN_EMAIL" ] && [ -z "$STAFF_EMAIL" ] && [ -z "$ALUM_EMAIL" ]; then
  echo -e "Email: ${YELLOW}test@example.com${NC}"
fi

echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo -e "${GREEN}ğŸ’¡ Want realistic data?${NC}"
echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo -e "Run: ${YELLOW}./scripts/seed-sample-data${NC}"
echo -e "   â€¢ 100 realistic alumni (BSc/MSc mix)"
echo -e "   â€¢ 50 events (40 past, 10 upcoming)"
echo -e "   â€¢ 50 announcements with deadlines"
echo -e "   â€¢ Removes test@example.com user"
echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}\n"

echo -e "${GREEN}Starting frontend dev server...${NC}\n"

# Start the frontend (this will block)
# Use --clearScreen false to preserve our output above
bun run dev -- --clearScreen false
