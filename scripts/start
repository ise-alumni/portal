#!/bin/bash
set -e

# Colors for output
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
RED='\033[0;31m'
NC='\033[0m' # No Color

# Cleanup function for graceful shutdown
cleanup() {
    echo ""
    echo -e "${YELLOW}ğŸ›‘ Shutting down...${NC}"

    # Check if Supabase is running
    if supabase status &> /dev/null; then
        echo -e "${BLUE}Supabase is still running in the background.${NC}"
        read -p "$(echo -e ${YELLOW}Do you want to stop Supabase? [y/N]: ${NC})" -n 1 -r
        echo ""
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            echo -e "${YELLOW}Stopping Supabase...${NC}"
            supabase stop
            echo -e "${GREEN}âœ“ Supabase stopped${NC}"
        else
            echo -e "${BLUE}Supabase containers are still running.${NC}"
            echo -e "${BLUE}To stop them later, run: ${YELLOW}./scripts/stop${NC} or ${YELLOW}supabase stop${NC}"
        fi
    fi

    exit 0
}

# Set up trap to catch Ctrl+C and other termination signals
trap cleanup SIGINT SIGTERM

echo -e "${GREEN}ğŸš€ Starting ISE Alumni Portal (Local Development)${NC}\n"

# Check if .env.local exists
if [ ! -f ".env.local" ]; then
    echo -e "${YELLOW}âš ï¸  .env.local not found. Run ./scripts/setup first!${NC}"
    exit 1
fi

# Check if Docker is running
if ! docker info &> /dev/null; then
    echo -e "${YELLOW}âŒ Docker is not running. Please start Docker Desktop.${NC}"
    exit 1
fi

# Start Supabase if not already running
echo "Starting local Supabase..."
if supabase status &> /dev/null; then
    echo -e "${GREEN}âœ“ Supabase already running${NC}"
else
    supabase start
    echo -e "${GREEN}âœ“ Supabase started${NC}"
fi
echo ""

# Display connection info
echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo -e "${GREEN}ğŸ”§ Local Development Environment${NC}"
echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo -e "Supabase Studio: ${YELLOW}http://127.0.0.1:54323${NC}"
echo -e "Database URL:     ${YELLOW}postgresql://postgres:postgres@127.0.0.1:54322/postgres${NC}"
echo -e "Frontend:         ${YELLOW}http://localhost:5173${NC}"
echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo -e "${GREEN}ğŸ”‘ Test User (Basic Seed)${NC}"
echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo -e "Email:    ${YELLOW}test@example.com${NC}"
echo -e "Password: ${YELLOW}password123${NC}"
echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo -e "${GREEN}ğŸ’¡ Want realistic data?${NC}"
echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo -e "Run: ${YELLOW}./scripts/seed-sample-data${NC}"
echo -e "   â€¢ 100 realistic alumni (BSc/MSc mix)"
echo -e "   â€¢ 50 events (40 past, 10 upcoming)"
echo -e "   â€¢ 50 announcements with deadlines"
echo -e "   â€¢ Removes test@example.com user"
echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}\n"

echo -e "${GREEN}Starting frontend dev server...${NC}\n"

# Start the frontend (this will block)
# Use --clearScreen false to preserve our output above
bun run dev -- --clearScreen false
