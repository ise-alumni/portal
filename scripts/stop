#!/bin/bash

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

echo -e "${BLUE}üõë Stopping ISE Alumni Portal development environment...${NC}\n"

STOPPED_ANYTHING=false

# Check and stop Supabase
echo "Checking for Supabase containers..."
if supabase status &> /dev/null; then
    echo -e "${YELLOW}Supabase is running. Stopping...${NC}"
    supabase stop
    echo -e "${GREEN}‚úì Supabase stopped${NC}"
    STOPPED_ANYTHING=true
else
    echo -e "${BLUE}‚úì Supabase is not running${NC}"
fi
echo ""

# Check for running Vite dev server (frontend)
echo "Checking for frontend dev server..."
VITE_PIDS=$(pgrep -f "vite" 2>/dev/null || true)
if [ -n "$VITE_PIDS" ]; then
    echo -e "${YELLOW}Found running Vite dev server(s). Stopping...${NC}"
    echo "$VITE_PIDS" | while read -r pid; do
        kill "$pid" 2>/dev/null || true
        echo -e "${GREEN}‚úì Stopped process $pid${NC}"
    done
    STOPPED_ANYTHING=true
else
    echo -e "${BLUE}‚úì No Vite dev server running${NC}"
fi
echo ""

# Check for any Bun processes running dev
echo "Checking for Bun dev processes..."
BUN_DEV_PIDS=$(pgrep -f "bun.*dev" 2>/dev/null || true)
if [ -n "$BUN_DEV_PIDS" ]; then
    echo -e "${YELLOW}Found running Bun dev process(es). Stopping...${NC}"
    echo "$BUN_DEV_PIDS" | while read -r pid; do
        kill "$pid" 2>/dev/null || true
        echo -e "${GREEN}‚úì Stopped process $pid${NC}"
    done
    STOPPED_ANYTHING=true
else
    echo -e "${BLUE}‚úì No Bun dev processes running${NC}"
fi
echo ""

# Clean up any .env.local.backup from interrupted start-with-prod
if [ -f ".env.local.backup" ]; then
    echo -e "${YELLOW}Found .env.local.backup from interrupted production mode session${NC}"
    if [ ! -f ".env.local" ]; then
        mv .env.local.backup .env.local
        echo -e "${GREEN}‚úì Restored .env.local${NC}"
        STOPPED_ANYTHING=true
    else
        echo -e "${YELLOW}‚ö†Ô∏è  Both .env.local and .env.local.backup exist${NC}"
        echo -e "${YELLOW}   Please manually review and delete .env.local.backup${NC}"
    fi
    echo ""
fi

# Summary
if [ "$STOPPED_ANYTHING" = true ]; then
    echo -e "${GREEN}‚úÖ Cleanup complete!${NC}"
else
    echo -e "${GREEN}‚úÖ Nothing was running. All clean!${NC}"
fi
