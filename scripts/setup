#!/bin/bash
set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

echo -e "${GREEN}ðŸš€ Setting up ISE Alumni Portal development environment...${NC}\n"

# Detect OS
OS="unknown"
if [[ "$OSTYPE" == "darwin"* ]]; then
    OS="macos"
elif [[ "$OSTYPE" == "linux-gnu"* ]]; then
    OS="linux"
elif [[ "$OSTYPE" == "msys" ]] || [[ "$OSTYPE" == "cygwin" ]] || [[ "$OSTYPE" == "win32" ]]; then
    OS="windows"
fi

echo "Detected OS: $OS"
echo ""

# Install Bun based on OS
echo "Checking for Bun..."
if ! command -v bun &> /dev/null; then
    echo -e "${YELLOW}âš ï¸  Bun not found. Installing...${NC}"

    if [ "$OS" == "macos" ]; then
        # Check for Homebrew on macOS
        if ! command -v brew &> /dev/null; then
            echo -e "${RED}âŒ Homebrew is not installed!${NC}"
            echo -e "Please install Homebrew first by running:"
            echo -e "${YELLOW}  /bin/bash -c \"\$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)\"${NC}"
            exit 1
        fi
        brew install oven-sh/bun/bun
    elif [ "$OS" == "linux" ]; then
        curl -fsSL https://bun.sh/install | bash
        # Source the shell config to get bun in PATH
        export BUN_INSTALL="$HOME/.bun"
        export PATH="$BUN_INSTALL/bin:$PATH"
    elif [ "$OS" == "windows" ]; then
        echo -e "${YELLOW}On Windows, please install Bun manually:${NC}"
        echo -e "${YELLOW}Run in PowerShell: powershell -c \"irm bun.sh/install.ps1|iex\"${NC}"
        echo -e "Then re-run this script."
        exit 1
    fi
else
    echo -e "${GREEN}âœ“ Bun found${NC}"
fi
echo ""

# Install project dependencies
echo "Installing project dependencies..."
bun install
echo -e "${GREEN}âœ“ Dependencies installed${NC}\n"

# Install Supabase CLI based on OS
echo "Checking for Supabase CLI..."
if ! command -v supabase &> /dev/null; then
    echo -e "${YELLOW}âš ï¸  Supabase CLI not found. Installing...${NC}"

    if [ "$OS" == "macos" ]; then
        if ! command -v brew &> /dev/null; then
            echo -e "${RED}âŒ Homebrew is not installed!${NC}"
            echo -e "Please install Homebrew first."
            exit 1
        fi
        brew install supabase/tap/supabase
    elif [ "$OS" == "linux" ]; then
        # Install via Homebrew on Linux if available, otherwise use binary
        if command -v brew &> /dev/null; then
            brew install supabase/tap/supabase
        else
            echo -e "${YELLOW}Installing Supabase CLI via binary...${NC}"
            # Detect architecture
            ARCH=$(uname -m)
            if [ "$ARCH" == "x86_64" ]; then
                ARCH="amd64"
            elif [ "$ARCH" == "aarch64" ]; then
                ARCH="arm64"
            fi

            # Download and install latest release
            curl -fsSL "https://github.com/supabase/cli/releases/latest/download/supabase_linux_${ARCH}.tar.gz" | tar -xz
            sudo mv supabase /usr/local/bin/
            rm -f supabase_linux_${ARCH}.tar.gz
        fi
    elif [ "$OS" == "windows" ]; then
        echo -e "${YELLOW}On Windows, install Supabase CLI using Scoop:${NC}"
        echo -e "${YELLOW}  scoop bucket add supabase https://github.com/supabase/scoop-bucket.git${NC}"
        echo -e "${YELLOW}  scoop install supabase${NC}"
        echo -e "Or download from: https://github.com/supabase/cli/releases"
        echo -e "Then re-run this script."
        exit 1
    fi
else
    echo -e "${GREEN}âœ“ Supabase CLI found${NC}"
fi

# Verify Supabase CLI is now available
if ! command -v supabase &> /dev/null; then
    echo -e "${RED}âŒ Supabase CLI installation failed${NC}"
    exit 1
fi

echo -e "${GREEN}âœ“ Supabase CLI installed ($(supabase --version))${NC}\n"

# Check if Docker is running
echo "Checking if Docker is running..."
if ! docker info &> /dev/null; then
    echo -e "${RED}âŒ Docker is not running!${NC}"
    if [ "$OS" == "macos" ] || [ "$OS" == "windows" ]; then
        echo -e "Please start Docker Desktop and try again."
    else
        echo -e "Please start Docker and try again."
        echo -e "Install Docker: https://docs.docker.com/engine/install/"
    fi
    exit 1
fi
echo -e "${GREEN}âœ“ Docker is running${NC}\n"

# Login to Supabase
echo "Checking Supabase authentication..."
if ! supabase projects list &> /dev/null; then
    echo -e "${YELLOW}Please login to Supabase:${NC}"
    supabase login
else
    echo -e "${GREEN}âœ“ Already logged in to Supabase${NC}"
fi
echo ""

# Link project (if not already linked)
echo "Linking Supabase project..."
if [ ! -f "supabase/.temp/project-ref" ]; then
    echo -e "${YELLOW}Enter your Supabase project ref (from your project URL):${NC}"
    echo -e "${YELLOW}Example: if your URL is https://cozbuiqfinmfylkqkdns.supabase.co${NC}"
    echo -e "${YELLOW}Then your project ref is: cozbuiqfinmfylkqkdns${NC}"
    read -p "Project ref: " PROJECT_REF
    supabase link --project-ref "$PROJECT_REF"
else
    echo -e "${GREEN}âœ“ Project already linked${NC}"
fi
echo ""

# Start Supabase (this downloads images and sets up the local environment)
echo "Starting local Supabase environment..."
echo -e "${YELLOW}This will download Docker images (~4-5GB) on first run...${NC}"
supabase start
echo -e "${GREEN}âœ“ Supabase started${NC}\n"

# Create .env.local for local development
echo "Setting up local environment variables..."

if [ -f ".env.local" ]; then
    echo -e "${YELLOW}âš ï¸  .env.local already exists. Skipping creation to preserve your customizations.${NC}"
    echo -e "${YELLOW}   If you need to regenerate it, delete .env.local and run this script again.${NC}"
else
    # Get Supabase configuration from local instance
    ANON_KEY=$(supabase status | grep "Publishable" | awk -F 'â”‚' '{print $3}' | tr -d ' ')
    API_URL=$(supabase status | grep "Project URL" | awk -F 'â”‚' '{print $3}' | tr -d ' ')

    # Get Mapbox token from .env if it exists
    MAPBOX_TOKEN=""
    if [ -f ".env" ]; then
        MAPBOX_TOKEN=$(grep VITE_MAPBOX_TOKEN .env | cut -d '=' -f2 | tr -d '"' | tr -d "'")
    fi

    # Prompt for Mapbox token if not found
    if [ -z "$MAPBOX_TOKEN" ]; then
        echo -e "${YELLOW}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
        echo -e "${YELLOW}Mapbox Token Required${NC}"
        echo -e "${YELLOW}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
        echo -e "The application requires a Mapbox token for map functionality."
        echo -e "You can get a free token at: ${YELLOW}https://account.mapbox.com/access-tokens/${NC}"
        echo ""
        echo -e "Enter your Mapbox token (or press Enter to skip and set it later):"
        read -p "> " MAPBOX_TOKEN
        echo ""
    fi

    # Create .env.local with auto-filled values
    cat > .env.local << EOF
# Local Development Environment Variables
# This file overrides .env for local development
# DO NOT commit this file to git

# Local Supabase Configuration (auto-generated)
VITE_SUPABASE_URL=$API_URL
VITE_SUPABASE_ANON_KEY=$ANON_KEY

# Mapbox Token
VITE_MAPBOX_TOKEN=$MAPBOX_TOKEN

# Log Level (more verbose locally)
VITE_LOG_LEVEL=debug

# React Scan (enabled for dev)
VITE_REACT_SCAN_ENABLED=true
EOF
    echo -e "${GREEN}âœ“ Created .env.local${NC}"

    # Warn if Mapbox token is still empty
    if [ -z "$MAPBOX_TOKEN" ]; then
        echo -e "${YELLOW}âš ï¸  VITE_MAPBOX_TOKEN is not set in .env.local${NC}"
        echo -e "${YELLOW}   The app may not work fully until you add your Mapbox token.${NC}"
        echo -e "${YELLOW}   Edit .env.local and set VITE_MAPBOX_TOKEN=your_token_here${NC}"
    fi
fi
echo ""

# Success message
echo -e "${GREEN}âœ… Setup complete!${NC}\n"
echo -e "Available commands:"
echo -e "  ${YELLOW}./scripts/start${NC}       - Start local Supabase + frontend"
echo -e "  ${YELLOW}./scripts/stop${NC}        - Stop all services"
echo -e ""
echo -e "Supabase Studio (local): ${YELLOW}http://127.0.0.1:54323${NC}"
echo -e "Frontend: ${YELLOW}http://localhost:5173${NC} (after running ./scripts/start)"
